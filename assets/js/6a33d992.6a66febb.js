"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[851],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>u});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c="mdxType",b={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),c=p(a),d=r,u=c["".concat(s,".").concat(d)]||c[d]||b[d]||o;return a?n.createElement(u,i(i({ref:t},m),{},{components:a})):n.createElement(u,i({ref:t},m))}));function u(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},2021:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>b,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const o={sidebar_position:3},i="Jobs",l={unversionedId:"guide-to-dynamic-builds/jobs",id:"guide-to-dynamic-builds/jobs",title:"Jobs",description:"A workflow handler function is responsible for submitting Jobs to be run as part of the build. Each job",source:"@site/docs/guide-to-dynamic-builds/jobs.md",sourceDirName:"guide-to-dynamic-builds",slug:"/guide-to-dynamic-builds/jobs",permalink:"/docs/guide-to-dynamic-builds/jobs",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Workflows",permalink:"/docs/guide-to-dynamic-builds/workflows"},next:{title:"Steps",permalink:"/docs/guide-to-dynamic-builds/steps"}},s={},p=[{value:"Submitting a Job",id:"submitting-a-job",level:2},{value:"Job Definitions",id:"job-definitions",level:2},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Secrets",id:"secrets",level:2},{value:"Artifacts",id:"artifacts",level:2},{value:"Job Dependencies",id:"job-dependencies",level:2}],m={toc:p},c="wrapper";function b(e){let{components:t,...a}=e;return(0,r.kt)(c,(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"jobs"},"Jobs"),(0,r.kt)("p",null,"A workflow handler function is responsible for submitting ",(0,r.kt)("em",{parentName:"p"},"Jobs")," to be run as part of the build. Each job\ncontains one or more ",(0,r.kt)("em",{parentName:"p"},"Steps"),"."),(0,r.kt)("p",null,"All Steps within a Job are run within the same environment and so steps can share files or other state. Each job\nruns within its own separate environment and should not expect files from other jobs to be available; instead it\nshould declare ",(0,r.kt)("a",{parentName:"p",href:"jobs#job-dependencies"},"Artifact Dependencies")," to make files from other jobs available."),(0,r.kt)("h2",{id:"submitting-a-job"},"Submitting a Job"),(0,r.kt)("p",null,"A new Job is added to a workflow by calling ",(0,r.kt)("inlineCode",{parentName:"p"},"NewJob()")," to create a ",(0,r.kt)("em",{parentName:"p"},"Job object"),", then calling the workflow Job()\nmethod to add to a list of jobs ready to be submitted to the server. After the workflow\nfunction returns, any outstanding jobs will be submitted. Properties are set on the Job object by\ncalling methods on the object."),(0,r.kt)("p",null,"Here's a complete example of a Workflow Handler that submits a Job, written in Go:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func handler(w *bb.Workflow) error {\n    w.Job(bb.NewJob().\n        Name("test-job").\n        Docker(bb.NewDocker().Image("docker:20.10").Pull(bb.DockerPullIfNotExists)).\n        Step(bb.NewStep().\n            Name("test-job-step").\n            Commands("echo This is the test job..."), \n    ))\n    return nil\n}\n')),(0,r.kt)("p",null,"To submit jobs immediately instead of waiting until the workflow handler returns, call Submit(), or MustSubmit() if you don't want to deal with errors:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (w *Workflow) Submit(waitForCallbacks ...bool) ([]client.JobGraph, error)\nfunc (w *Workflow) MustSubmit(waitForCallbacks ...bool) []client.JobGraph\n")),(0,r.kt)("p",null,"Submit() will submit all new jobs to the server and return details for the newly created jobs. If\nwaitForCallbacks is true, or not specified, Submit() will wait until all outstanding callbacks have been called\nbefore returning. MustSubmit() is the same but will exit the program with status 1 on error, causing the build to fail."),(0,r.kt)("h2",{id:"job-definitions"},"Job Definitions"),(0,r.kt)("p",null,"The following methods are available to set properties on a Job; additional methods are described in later\nsections:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Name")," (mandatory): a name to use when referencing the job.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Desc")," (optional): a human-readable description for the job.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Step")," (mandatory): each ",(0,r.kt)("em",{parentName:"p"},"Step")," is added to the Job by calling NewStep() to create a ",(0,r.kt)("em",{parentName:"p"},"Step object"),",\nthen calling the Job's Step() method to add the step. See ",(0,r.kt)("a",{parentName:"p",href:"steps"},"Steps")," for details and examples.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"StepExecution")," (optional): specifies whether the Steps in this Job should be run sequentially (the default)\nor in parallel. Possible values are ",(0,r.kt)("inlineCode",{parentName:"p"},"StepExecutionSequential")," or  ",(0,r.kt)("inlineCode",{parentName:"p"},"StepExecutionParallel"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Type")," (optional): specifies whether this job runs in a Docker container (",(0,r.kt)("inlineCode",{parentName:"p"},"JobTypeDocker"),"),\nor natively on the same machine as the runner or bb command (",(0,r.kt)("inlineCode",{parentName:"p"},"JobTypeExec"),").\nCan be omitted if a ",(0,r.kt)("a",{parentName:"p",href:"docker-configuration"},"Docker Configuration")," is specified via the\nDocker() method. For native/exec jobs ",(0,r.kt)("inlineCode",{parentName:"p"},"Type(bb.JobTypeExec)")," must be specified explicitly.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Docker")," (mandatory for Docker Jobs): specifies how to run the Job in a Docker container, for Jobs with ",(0,r.kt)("inlineCode",{parentName:"p"},"JobTypeDocker"),".\nCall NewDocker() to create a ",(0,r.kt)("em",{parentName:"p"},"Docker Config object"),", then call the Job's Docker() method\nto use it for the Job. See ",(0,r.kt)("a",{parentName:"p",href:"docker-configuration"},"Docker Configuration")," for details and examples.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"RunsOn")," (optional): a set of labels constraining which types of runner the job can run on. Only runners\nwhich have all of these labels will be eligible to run this Job. Not relevant when builds are run using\nthe ",(0,r.kt)("em",{parentName:"p"},"bb")," command line tool.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"OnCompletion"),", ",(0,r.kt)("strong",{parentName:"p"},"OnSuccess"),", ",(0,r.kt)("strong",{parentName:"p"},"OnFailure"),", ",(0,r.kt)("strong",{parentName:"p"},"OnStatusChanged")," (optional): Call the supplied callback function\nafter the Job is completed. See ",(0,r.kt)("a",{parentName:"p",href:"callbacks-and-waits#job-callbacks"},"Job Callbacks")," for details and examples.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Fingerprint")," (optional): specifies a way to calculate a ",(0,r.kt)("em",{parentName:"p"},"fingerprint")," for inputs to the Job, allowing\nexecution to be skipped if a previous build already ran the Job with the same inputs, and therefore\nalready produced the required artifacts. See ",(0,r.kt)("a",{parentName:"p",href:"fingerprints"},"Fingerprints")," for details and examples.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Service")," (optional): Jobs can make use of services such as databases by calling NewService() to create\na ",(0,r.kt)("em",{parentName:"p"},"Service object"),", then calling the Job's Service() method to associate the service with the Job.\nSee ",(0,r.kt)("a",{parentName:"p",href:"services"},"Services")," for details and examples."))),(0,r.kt)("h2",{id:"environment-variables"},"Environment Variables"),(0,r.kt)("p",null,"Jobs and Services can be provided information via environment variables. Variables specified in the Job object apply\nto every Step within the Job. The values for variables can be provided as literal values, or\n",(0,r.kt)("a",{parentName:"p",href:"jobs#secrets"},"Secrets")," can be used to ensure that the provided information remains secure."),(0,r.kt)("p",null,"Environment variables can be specified using the following Job method:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Env")," (optional): specifies an environment variable that should be passed to commands that run within the Job\nwhen they are executed. The Env() method can be called multiple times to add multiple variables.")),(0,r.kt)("p",null,"The following methods are available to set properties on an environment variable:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Name")," (mandatory): specifies the name of the environment variable to be provided to the Job. This can be\nreferenced from within shell commands with name in ALL_CAPS.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Value"),": specifies a literal value for the environment variable; use this only for values that do not\nneed to be kept secret.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"ValueFromSecret"),": the name of a ",(0,r.kt)("em",{parentName:"p"},"Secret")," used to obtain the value for the\nenvironment variable; the actual value will be fetched at runtime."))),(0,r.kt)("p",null,"(note that either ",(0,r.kt)("em",{parentName:"p"},"Value")," or ",(0,r.kt)("em",{parentName:"p"},"ValueFromSecret")," must be called)"),(0,r.kt)("p",null,"Here's an example of a Job being passed environment variables, with and without secrets:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'    w.Job(bb.NewJob().\n        Name("my-job").\n        Docker(....).\n        Env(bb.NewEnv().\n            Name("MY_ID").\n            Value("a-literal-value")).\n        Env(bb.NewEnv().\n            Name("AWS_SECRET_ACCESS_KEY").\n            ValueFromSecret("ACCESS_KEY_SECRET_NAME")).\n        Step(bb.NewStep().\n            Name("go-builder").\n            Commands("echo My ID is $MY_ID")))\n')),(0,r.kt)("h2",{id:"secrets"},"Secrets"),(0,r.kt)("p",null,"Secrets provide a mechanism to avoid sensitive information such as passwords or tokens having to be hard coded\ninto the build definition YAML or code. Secrets are used by providing a ",(0,r.kt)("em",{parentName:"p"},"secret name")," instead of a literal value,\nand can be used for ",(0,r.kt)("a",{parentName:"p",href:"jobs#environment-variables"},"Enviroment Variables")," or within\n",(0,r.kt)("a",{parentName:"p",href:"docker-configuration"},"Docker Configuration")," - see those sections for the syntax."),(0,r.kt)("p",null,"The values for secrets are provided at runtime:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Builds run via the "),"bb",(0,r.kt)("em",{parentName:"p"}," command-line tool"),": secret values must be provided via environment variables set before\n",(0,r.kt)("inlineCode",{parentName:"p"},"bb")," is run. You are responsible for ensuring the Environment variable are set; for each secret there must\nbe a corresponding environment variable with the same name.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Builds run from the BuildBeaver server"),": secret values are set within the Build Configuration via the GUI."))),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Secret names should normally be in ALL_CAPS since they are sourced from environment variables when using the\n",(0,r.kt)("inlineCode",{parentName:"p"},"bb")," command-line tool. Having everything in ALL_CAPS makes things simpler.")),(0,r.kt)("h2",{id:"artifacts"},"Artifacts"),(0,r.kt)("p",null,"An ",(0,r.kt)("em",{parentName:"p"},"Artifact")," is a set of files produced by the Job that form part of the output of the build. When builds are run on\na server, artifact files are stored after the build is completed. When a build is run via the ",(0,r.kt)("em",{parentName:"p"},"bb")," command line\ntool, artifact files remain on the local machine after the build is run."),(0,r.kt)("p",null,"The following Job method is used to define artifacts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Artifact")," (optional): call NewArtifact() to create an ",(0,r.kt)("em",{parentName:"li"},"Artifact object"),", then call the\nJob's Artifact() method to add the artifact. The Artifact() method can be called multiple times to define\nmore than one artifact.")),(0,r.kt)("p",null,"The following methods are available to set properties on an Artifact:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Name")," (mandatory): each artifact must have a name, unique within the build. Names must be identifiers that\ndo not contain spaces.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Paths")," (mandatory): specifies one or more strings, each defining a path that matches files that should be\nincluded in the artifact. Paths are relative to the checked-out source working directory.\nWildcards (*) can be used to pattern-match parts of a path."))),(0,r.kt)("p",null,"Here's an example in Go of a Job that defines an Artifact that includes all files in the reports directory (some details\nreplaced with ",(0,r.kt)("inlineCode",{parentName:"p"},"....")," for brevity):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'    w.Job(bb.NewJob().\n        Name("reporting-job").\n        Docker(....).\n        Step(....).\n        Artifact(bb.NewArtifact().\n            Name("reports").\n            Paths("reports/*")))\n')),(0,r.kt)("h2",{id:"job-dependencies"},"Job Dependencies"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Job dependencies")," can be used to ensure a job doesn't run until after another job completes, and optionally to\nmake available artifacts from another job. If no job dependencies are specified then all submitted jobs\nare eligible to run in parallel."),(0,r.kt)("p",null,"The following Job methods are available to define dependencies:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Depends")," (optional): specifies one or more dependencies as strings, using the YAML\n",(0,r.kt)("a",{parentName:"p",href:"../yaml-guide/job-dependency-syntax"},"Job Dependency Syntax"),". The specified job can be in a different\nworkflow from the dependent job; this can be used as a more efficient alternative to\n",(0,r.kt)("a",{parentName:"p",href:"workflows#workflow-dependencies"},"Workflow Dependencies"),"."),(0,r.kt)("p",{parentName:"li"},"Here's an example where ",(0,r.kt)("em",{parentName:"p"},"job-2")," depends on ",(0,r.kt)("em",{parentName:"p"},"job-1")," and requires all artifacts from ",(0,r.kt)("em",{parentName:"p"},"job-1")," to be available\n(some details replaced with ",(0,r.kt)("inlineCode",{parentName:"p"},"....")," for brevity):"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-go"},'    w.Job(bb.NewJob().\n        Name("job-1").\n        Docker(....).\n        Step(....).\n        Artifact(bb.NewArtifact().Name("reports").Paths("reports/*")))\n    w.Job(bb.NewJob().\n        Name("job-2").\n        Depends("my-workflow.job-1.artifacts").\n        Docker(....).\n        Step(....))\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"DependsOnJobs")," (optional): indicates that the job depends on the specified other jobs, provided as\nreferences to Job objects defined previously.\nThis is a simpler alternative to using dependency strings of the form ",(0,r.kt)("inlineCode",{parentName:"p"},"workflowname.jobname")," (see example below).")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"DependsOnJobArtifacts")," (optional): indicates that the job depends on the specified other jobs, and that\nall artifacts from those jobs should be made available to the dependent job.\nThis is a simpler alternative to using dependency strings of the form ",(0,r.kt)("inlineCode",{parentName:"p"},"workflowname.jobname.artifacts"),". Here's an example:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-go"},'    job1 := bb.NewJob().\n        Name("job-1").\n        Docker(....).\n        Step(....).\n        Artifact(bb.NewArtifact().Name("reports").Paths("reports/*")))\n    w.Job(job1)\n\n    w.Job(bb.NewJob().\n        Name("job-2").\n        DependsOnJobArtifacts(job1).\n        Docker(....).\n        Step(....))  \n')))))}b.isMDXComponent=!0}}]);